import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import arabic_reshaper
from bidi.algorithm import get_display

def main():
    # ุถุจุท ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
    st.set_page_config(page_title="ุฑุญูุฉ ุงูุชุฎุฑุฌ", layout="centered")
    
    # ููุฏูุฉ ุงูุชุทุจูู ูุน ุชูุณูู HTML
    st.markdown("""
    <h1 style='text-align: center;'>๐ ุฑุญูุฉ ุงูุชุฎุฑุฌ ๐</h1>
    <div style='text-align: center; font-size:18px; margin-top: 20px;'>
        <p><strong>ุจุฏุงูุฉ ุงูุฑุญูุฉ โ ูุญุธุฉ ุงูุชุฎุฑุฌ:</strong></p>
        <p>
            ุจุนุฏ ูุณูุฑุฉ ุฃูุซุฑ ูู ูกูข ุนุงููุง ูููุฆุฉ ุจุงูุฏุฑุงุณุฉ ูุงูุงุฎุชุจุงุฑุงุชุ ุฌุงุก ุงูููู ุงูููุชุธุฑ ุงูุฐู ูุญุชูู ููู 
            ุนุฏุฏ ูุจูุฑ ูู ุฎุฑูุฌู ุงูุฌุงูุนุงุช ุจุชุฎุฑุฌูู. ูู ูุฐู ุงููุญุธุฉ ุงูุชุงุฑูุฎูุฉุ ูุญูู ูู ุฎุฑูุฌ ุญูููุง ูุจูุฑูุง 
            ูุทููุญูุง ูุง ุญุฏูุฏ ูู. ุจุนุฏ ูุฐุง ุงููููุ ุชุจุฏุฃ ุฑุญูุฉ ุงูุจุญุซ ุนู ูุธููุฉ ุงูุฃุญูุงูุ ูุญููุฉ ุจุชููุนุงุช ูุขูุงู 
            ูุซูุฑุฉ ููุฑุต ุฑุจูุง ุฃูุซุฑ.
        </p>
        <p>ููุน ุฐููุ ุชุธูุฑ ุชุณุงุคูุงุช ุนุฏุฉ ูู ุจุงู ุงูุฎุฑูุฌููุ ูุซู:</p>
        <p>๐ค ูู ุณูุฌุฏ ูุธููุฉ ุฃุญูุงููุง ุฑุบู ุนุฏู ุงูุชูุงููุง ููุฎุจุฑุฉ ุงููุงููุฉุ</p>
        <p>๐ฐ ูู ุณูููู ูุชูุณุท ุงูุฑุงุชุจ ุงูุฐู ุณูุญุตู ุนูููุ</p>
        <p>๐๏ธ ูู ูุฌุจ ุฃู ูุชูุฌู ุฅูู ุงูุนุงุตูุฉ ุฃู ุงููุฏู ุงููุจูุฑุฉ ููุฌุฏ ูุฑุต ุนูู ุฃูุถูุ ุฃู ุฃู ููุทูุชูุง ุชููุฑ ุงููุธุงุฆู ุงูููุงุณุจุฉุ</p>
        <p>๐ข ูู ุงูุงุฎุชูุงุฑ ุงูุฃูุถู ูู ุงูุนูู ูู ุงููุทุงุน ุงูุฎุงุต ุฃู ุงูุญููููุ</p>
        <p>
            ุชูู ุงูุชุณุงุคูุงุช ุงูุชู ุชุชุฑุฏุฏ ูู ุฃุฐูุงู ุงููุซูุฑูู ุจุนุฏ ุงูุชุฎุฑุฌ ุชุณุชุฏุนู ุฅุฌุงุจุงุช ูุงุถุญุฉ ูุนูููุฉ.
            ููุงุ ูุฏุนููู ูุงุณุชูุดุงู ููุตุฉ "ุฌุฏุงุฑุงุช" ุงููุนุฑููุฉุ ุญูุซ ูุนุฑุถ ููู ุงูุจูุงูุงุช ูุงูุฅุญุตุงุฆูุงุช ุฏูู ููุณูุฉ 
            ุฃู ุชูุธูุฑุ ูููุฏู ููู ุฑุคู ููุถูุนูุฉ ุชุณุงุนุฏ ูู ุฑุณู ููุงูุญ ุงููุณุชูุจู ุงููููู ุจุซูุฉ ููุงูุนูุฉ.
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # ููุฑุฉ "ุงูุชุญุฏูุงุช ุงูุฃูููุฉ โ ููุงุฌูุฉ ุณูู ุงูุนูู"
    st.markdown("""
    <div style='text-align: center; font-size:18px; margin-top: 40px;'>
        <p><strong>ุงูุชุญุฏูุงุช ุงูุฃูููุฉ โ ููุงุฌูุฉ ุณูู ุงูุนูู:</strong></p>
        <p>
            ูุน ุจุฏุงูุฉ ุจุญุซูู ุนู ูุฑุต ุงูุนููุ ููุงุฌู ุงูุฎุฑูุฌูู ูุงูุนุงู ูุฎุชููุงู ุนู ุฃูุงูููู ุงูุฌุงูุนูุฉ.
            ุชูุจุฑุฒ ุงูุจูุงูุงุช ูุนุฏูุงุช ุงูุชูุธูู ููู ุชุฎุตุตุ ุญูุซ ูุธูุฑ ุฃู ุจุนุถ ุงูุชุฎุตุตุงุช ุชุญุธู ุจูุฑุต ุนูู ูููุฑุฉุ
            ุจูููุง ุชูุงุฌู ุฃุฎุฑู ุตุนูุจุฉ ุฃูุจุฑ ูู ุฏุฎูู ุณูู ุงูุนูู. ููุง ุชุจุฏุฃ ุงููุตุฉ ุงูุญููููุฉุ ุฅุฐ ูุชุฌูู
            ุงููุงุฑู ุจูู ุงูุชููุนุงุช ูุงููุงูุน.
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # ูุฑุงุกุฉ ุงูููู "cleaned_jadarat.csv" ูุงุณุชุฎุฏุงูู ูู ุงูุชุทุจูู
    try:
        df = pd.read_csv("cleaned_jadarat.csv")
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูููู: {e}")
        return

    # ุงุณุชุฎุฏุงู ุงูุฏุงุชุง ุณูุช ุจุงุณู jadarat
    jadarat = df
    
    # =============================
    # ูุณู ุนุฑุถ ุงูุฑุณู ุงูุจูุงูู ูุฃุนูู 10 ูุธุงุฆู ูุทููุจุฉ
    st.subheader("ุชุญููู ุงููุธุงุฆู ุงูุฃูุซุฑ ุทูุจุงู ูู ุงูุณูู")
    
    # ุชุญุฏูุฏ ููุญุฉ ุฃููุงู ูุฎุตุตุฉ
    custom_palette = sns.color_palette("viridis", n_colors=10)
    
    # ุญุณุงุจ ุงููุธุงุฆู ุงูุฃูุซุฑ ุทูุจุงู (ููุถู ุฃู ูููู ุงุณู ุงูุนููุฏ "job_title" ุฃู "JobTitle")
    if 'job_title' in jadarat.columns:
        top_jobs = jadarat['job_title'].value_counts().head(10)
    elif 'JobTitle' in jadarat.columns:
        top_jobs = jadarat['JobTitle'].value_counts().head(10)
    else:
        st.error("ุนููุฏ ุงููุธุงุฆู ุบูุฑ ููุฌูุฏ ูู ุงูุฏุงุชุง ุณูุช.")
        return

    # ุฅุนุงุฏุฉ ุชุดููู ุงููุต ุงูุนุฑุจู ููุนุฑุถ ุงูุตุญูุญ
    reshaped_title = get_display(arabic_reshaper.reshape("ุฃุนูู 10 ูุธุงุฆู ูุทููุจุฉ ูู ุงูุณูู ุญุณุจ ุชุญููู ุจูุงูุงุช ููุตุฉ ุฌุฏุงุฑุงุช ูขููขูฃ"))
    reshaped_xlabel = get_display(arabic_reshaper.reshape("ุนุฏุฏ ุงููุธุงุฆู"))
    reshaped_ylabel = get_display(arabic_reshaper.reshape("ุงููุณูู ุงููุธููู"))
    
    # ุฅุนุฏุงุฏ ุญุฌู ุงูุดูู
    plt.figure(figsize=(10, 5))
    
    # ุฑุณู ุงููุฎุทุท ุงูุดุฑูุทู ุงูุฃููู ุจุงุณุชุฎุฏุงู ููุญุฉ ุงูุฃููุงู ุงููุฎุตุตุฉ
    sns.barplot(
        x=top_jobs.values, 
        y=[get_display(arabic_reshaper.reshape(job)) for job in top_jobs.index],
        palette=custom_palette[:len(top_jobs)]
    )
    
    # ุฅุถุงูุฉ ุงูุนููุงู ูุงููุญุงูุฑ
    plt.title(reshaped_title, fontsize=14)
    plt.xlabel(reshaped_xlabel, fontsize=12)
    plt.ylabel(reshaped_ylabel, fontsize=12)
    
    # ุนุฑุถ ุงููุฎุทุท ูู ุชุทุจูู Streamlit
    st.pyplot(plt.gcf())
    plt.clf()  # ุชูุฑูุบ ุงูุดูู ุงูุญุงูู

    # =============================
    # ูุณู ุนุฑุถ ูุงุฆูุฉ ุงููุธุงุฆู ุงููุฑูุฏุฉ ููุณุจ ุชููุฑูุง
    st.subheader("ุงุฎุชุฑ ุงููุธููุฉ ููุนุฑูุฉ ูุฏู ุชููุฑูุง ูู ุงูุจูุงูุงุช:")
    
    # ุญุณุงุจ ุชูุฑุงุฑุงุช ุงููุธุงุฆู (ูุนุชูุฏูุง ุนูู ููุณ ุงูุนููุฏ ุงููุณุชุฎุฏู ุณุงุจูุงู)
    if 'job_title' in jadarat.columns:
        job_counts = jadarat["job_title"].value_counts()
    elif 'JobTitle' in jadarat.columns:
        job_counts = jadarat["JobTitle"].value_counts()
    else:
        st.error("ุนููุฏ ุงููุธุงุฆู ุบูุฑ ููุฌูุฏ ูู ุงูุฏุงุชุง ุณูุช.")
        return
    
    selected_job = st.selectbox("ุงููุธุงุฆู ุงููุชุงุญุฉ", job_counts.index)
    
    count = job_counts[selected_job]
    total = job_counts.sum()
    ratio = (count / total) * 100
    
    st.write("**ุนุฏุฏ ุชููุฑ ูุฐู ุงููุธููุฉ:** {}".format(count))
    st.write("**ูุณุจุฉ ุชููุฑูุง ููุงุฑูุฉ ุจุจููุฉ ุงููุธุงุฆู:** {:.2f}%".format(ratio))

if __name__ == "__main__":
    main()
